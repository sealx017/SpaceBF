
<table style="width:100%">
<tr>
<td style="text-align:left; vertical-align:middle;">
<h1>
SpaceBF
</h1>
<p>
<strong>Authors:</strong> Souvik Seal and Brian Neelon
</p>
</td>
<td style="text-align:right; padding-left:400px;">
<img src="SpaceBF_logo.png" width="140" height="150"/>
</td>
</tr>
</table>

This *R* package implements the models proposed in the paper “SpaceBF:
Spatial Coexpression Analysis Using Bayesian Fused Approaches in Spatial
Omics Datasets.” It enables the analysis of spatially varying
co-expression between pairs of molecules, such as ligand-receptor
interactions, in spatial transcriptomics (ST) and mass spectrometry
imaging (MSI) datasets. It is applicable to broader spatial datasets as
well, to study spatially varying interaction between any two variables.

## Load the packages

We install and load the developmental version of SpaceBF from GitHub.

``` r

#suppressWarnings(devtools::install_github('sealx017/SpaceBF', quiet = TRUE))
#install.packages("SpaceBF")
library(SpaceBF)
# Warning: replacing previous import 'circlize::degree' by 'igraph::degree' when
# loading 'SpaceBF'

# # packages providing functional help
# library(Matrix)
# library(igraph)
# library(MERINGUE)
# 
# # packages providing plotting help
# library(ggplot2)
# library(circlize)
# library(RColorBrewer)
# library(ggraph)
# library(latex2exp)
# library(patchwork)
```

## Load the coordinates of the Melanoma dataset and compute the MST

``` r
data("mela_coords") # three columns corresponding to xy coordinates and celltypes

# compute Euclidean distance matrix and construct MST
coords <- mela_coords
x <- dist(coords[, 1:2]) # consider xy coordinates only
N <- nrow(coords)        # number of locations
mst.out <- MST_construction(x, type = "random")
mst.adjmat <- mst.out[[1]]
print_mst(mst.out, coords[, 1:2])
```

<img src="README_files/figure-gfm/loading the coords-1.png" width="50%" />

``` r

# optional network to compute MERINGUE cross-correlation
#w <- getSpatialNeighbors(coords[, 1:2], filterDist = 5) # constructing Delauney netwrok 
                                                         # using  MERINGUE
#plotNetwork(coords[, 1:2], w)
```

## Construct the kernel covariance matrix

This function can be used to perform the entire analysis at one go,
starting from summary function estimation to the univariate and
multivariate FANOVA-based association analyses.

``` r

# spatial kernel covariance matrix with exponential kernel function
K <- kernel_mat(x, l = 7.2, type = "exponential") 

# visualizing the kernel function to get an idea about spatial structure
palettes <-  sort(hcl.pals("divergingx"))
col_fun <- circlize::colorRamp2(c(0, 0.5, 1), hcl_palette = palettes[15], reverse = T) # spectral palette
ComplexHeatmap::Heatmap(K, cluster_rows = F, cluster_columns = F, col = 
  col_fun, show_row_names = FALSE,  show_column_names = FALSE, 
  heatmap_legend_param = list(title = "value"))
```

<img src="README_files/figure-gfm/construct kernel matrix-1.png" width="50%" />

## Simulate count expression data using bivariate Gaussian copula

``` r
set.seed(2025*2)

# generate bivariate Gaussian data across space: (y1, y2)^T, y1, y2 are N x 1
nu = 0.5                                          # correlation term 
y_latent_both <- c(MASS::mvrnorm(1, rep(0, 2*N), 
kronecker(matrix(c(1, nu, nu, 1), nrow = 2), K))) #kronecker product sturcture

y1_latent <- y_latent_both[1:N]; y2_latent <- y_latent_both[-c(1:N)]
U1 = pnorm(y1_latent); U2 = pnorm(y2_latent) # transformation using the CDF of standard normal

NB_q1 <- NB_q2 <- 0.2              # NB probabilities 
r1 <- r2 <- 1                      # NB dispersion parameters

y1 <- qnbinom(U1, r1, NB_q1)       # inverse of NB CDF for both variables
y2 <- qnbinom(U2, r2, NB_q2)
```

The main function “SpaceBF” fits both the negative binomial (which.model
= “NB”) and Gaussian (which.model = “Gauss”) models. The arguments y1
and y2 should correspond to the cell/location-level expression vector of
two genes (regressing y1 on y2). X denotes the matrix of additional
cell-level covariates. G denotes the MST graph adjacency matrix. nIter
denotes the number of MCMC iterations.

``` r
MM <- SpaceBF(y1, y2, X = NULL, G = mst.adjmat, which.model = "NB", nIter = 1000)
# [1] "SpaceBF: NB model fitting has started."
# Progress:    1 on 1000  Progress:    2 on 1000  Progress:    3 on 1000  Progress:    4 on 1000  Progress:    5 on 1000  Progress:    6 on 1000  Progress:    7 on 1000  Progress:    8 on 1000  Progress:    9 on 1000  Progress:   10 on 1000  Progress:   11 on 1000  Progress:   12 on 1000  Progress:   13 on 1000  Progress:   14 on 1000  Progress:   15 on 1000  Progress:   16 on 1000  Progress:   17 on 1000  Progress:   18 on 1000  Progress:   19 on 1000  Progress:   20 on 1000  Progress:   21 on 1000  Progress:   22 on 1000  Progress:   23 on 1000  Progress:   24 on 1000  Progress:   25 on 1000  Progress:   26 on 1000  Progress:   27 on 1000  Progress:   28 on 1000  Progress:   29 on 1000  Progress:   30 on 1000  Progress:   31 on 1000  Progress:   32 on 1000  Progress:   33 on 1000  Progress:   34 on 1000  Progress:   35 on 1000  Progress:   36 on 1000  Progress:   37 on 1000  Progress:   38 on 1000  Progress:   39 on 1000  Progress:   40 on 1000  Progress:   41 on 1000  Progress:   42 on 1000  Progress:   43 on 1000  Progress:   44 on 1000  Progress:   45 on 1000  Progress:   46 on 1000  Progress:   47 on 1000  Progress:   48 on 1000  Progress:   49 on 1000  Progress:   50 on 1000  Progress:   51 on 1000  Progress:   52 on 1000  Progress:   53 on 1000  Progress:   54 on 1000  Progress:   55 on 1000  Progress:   56 on 1000  Progress:   57 on 1000  Progress:   58 on 1000  Progress:   59 on 1000  Progress:   60 on 1000  Progress:   61 on 1000  Progress:   62 on 1000  Progress:   63 on 1000  Progress:   64 on 1000  Progress:   65 on 1000  Progress:   66 on 1000  Progress:   67 on 1000  Progress:   68 on 1000  Progress:   69 on 1000  Progress:   70 on 1000  Progress:   71 on 1000  Progress:   72 on 1000  Progress:   73 on 1000  Progress:   74 on 1000  Progress:   75 on 1000  Progress:   76 on 1000  Progress:   77 on 1000  Progress:   78 on 1000  Progress:   79 on 1000  Progress:   80 on 1000  Progress:   81 on 1000  Progress:   82 on 1000  Progress:   83 on 1000  Progress:   84 on 1000  Progress:   85 on 1000  Progress:   86 on 1000  Progress:   87 on 1000  Progress:   88 on 1000  Progress:   89 on 1000  Progress:   90 on 1000  Progress:   91 on 1000  Progress:   92 on 1000  Progress:   93 on 1000  Progress:   94 on 1000  Progress:   95 on 1000  Progress:   96 on 1000  Progress:   97 on 1000  Progress:   98 on 1000  Progress:   99 on 1000  Progress:  100 on 1000  Progress:  101 on 1000  Progress:  102 on 1000  Progress:  103 on 1000  Progress:  104 on 1000  Progress:  105 on 1000  Progress:  106 on 1000  Progress:  107 on 1000  Progress:  108 on 1000  Progress:  109 on 1000  Progress:  110 on 1000  Progress:  111 on 1000  Progress:  112 on 1000  Progress:  113 on 1000  Progress:  114 on 1000  Progress:  115 on 1000  Progress:  116 on 1000  Progress:  117 on 1000  Progress:  118 on 1000  Progress:  119 on 1000  Progress:  120 on 1000  Progress:  121 on 1000  Progress:  122 on 1000  Progress:  123 on 1000  Progress:  124 on 1000  Progress:  125 on 1000  Progress:  126 on 1000  Progress:  127 on 1000  Progress:  128 on 1000  Progress:  129 on 1000  Progress:  130 on 1000  Progress:  131 on 1000  Progress:  132 on 1000  Progress:  133 on 1000  Progress:  134 on 1000  Progress:  135 on 1000  Progress:  136 on 1000  Progress:  137 on 1000  Progress:  138 on 1000  Progress:  139 on 1000  Progress:  140 on 1000  Progress:  141 on 1000  Progress:  142 on 1000  Progress:  143 on 1000  Progress:  144 on 1000  Progress:  145 on 1000  Progress:  146 on 1000  Progress:  147 on 1000  Progress:  148 on 1000  Progress:  149 on 1000  Progress:  150 on 1000  Progress:  151 on 1000  Progress:  152 on 1000  Progress:  153 on 1000  Progress:  154 on 1000  Progress:  155 on 1000  Progress:  156 on 1000  Progress:  157 on 1000  Progress:  158 on 1000  Progress:  159 on 1000  Progress:  160 on 1000  Progress:  161 on 1000  Progress:  162 on 1000  Progress:  163 on 1000  Progress:  164 on 1000  Progress:  165 on 1000  Progress:  166 on 1000  Progress:  167 on 1000  Progress:  168 on 1000  Progress:  169 on 1000  Progress:  170 on 1000  Progress:  171 on 1000  Progress:  172 on 1000  Progress:  173 on 1000  Progress:  174 on 1000  Progress:  175 on 1000  Progress:  176 on 1000  Progress:  177 on 1000  Progress:  178 on 1000  Progress:  179 on 1000  Progress:  180 on 1000  Progress:  181 on 1000  Progress:  182 on 1000  Progress:  183 on 1000  Progress:  184 on 1000  Progress:  185 on 1000  Progress:  186 on 1000  Progress:  187 on 1000  Progress:  188 on 1000  Progress:  189 on 1000  Progress:  190 on 1000  Progress:  191 on 1000  Progress:  192 on 1000  Progress:  193 on 1000  Progress:  194 on 1000  Progress:  195 on 1000  Progress:  196 on 1000  Progress:  197 on 1000  Progress:  198 on 1000  Progress:  199 on 1000  Progress:  200 on 1000  Progress:  201 on 1000  Progress:  202 on 1000  Progress:  203 on 1000  Progress:  204 on 1000  Progress:  205 on 1000  Progress:  206 on 1000  Progress:  207 on 1000  Progress:  208 on 1000  Progress:  209 on 1000  Progress:  210 on 1000  Progress:  211 on 1000  Progress:  212 on 1000  Progress:  213 on 1000  Progress:  214 on 1000  Progress:  215 on 1000  Progress:  216 on 1000  Progress:  217 on 1000  Progress:  218 on 1000  Progress:  219 on 1000  Progress:  220 on 1000  Progress:  221 on 1000  Progress:  222 on 1000  Progress:  223 on 1000  Progress:  224 on 1000  Progress:  225 on 1000  Progress:  226 on 1000  Progress:  227 on 1000  Progress:  228 on 1000  Progress:  229 on 1000  Progress:  230 on 1000  Progress:  231 on 1000  Progress:  232 on 1000  Progress:  233 on 1000  Progress:  234 on 1000  Progress:  235 on 1000  Progress:  236 on 1000  Progress:  237 on 1000  Progress:  238 on 1000  Progress:  239 on 1000  Progress:  240 on 1000  Progress:  241 on 1000  Progress:  242 on 1000  Progress:  243 on 1000  Progress:  244 on 1000  Progress:  245 on 1000  Progress:  246 on 1000  Progress:  247 on 1000  Progress:  248 on 1000  Progress:  249 on 1000  Progress:  250 on 1000  Progress:  251 on 1000  Progress:  252 on 1000  Progress:  253 on 1000  Progress:  254 on 1000  Progress:  255 on 1000  Progress:  256 on 1000  Progress:  257 on 1000  Progress:  258 on 1000  Progress:  259 on 1000  Progress:  260 on 1000  Progress:  261 on 1000  Progress:  262 on 1000  Progress:  263 on 1000  Progress:  264 on 1000  Progress:  265 on 1000  Progress:  266 on 1000  Progress:  267 on 1000  Progress:  268 on 1000  Progress:  269 on 1000  Progress:  270 on 1000  Progress:  271 on 1000  Progress:  272 on 1000  Progress:  273 on 1000  Progress:  274 on 1000  Progress:  275 on 1000  Progress:  276 on 1000  Progress:  277 on 1000  Progress:  278 on 1000  Progress:  279 on 1000  Progress:  280 on 1000  Progress:  281 on 1000  Progress:  282 on 1000  Progress:  283 on 1000  Progress:  284 on 1000  Progress:  285 on 1000  Progress:  286 on 1000  Progress:  287 on 1000  Progress:  288 on 1000  Progress:  289 on 1000  Progress:  290 on 1000  Progress:  291 on 1000  Progress:  292 on 1000  Progress:  293 on 1000  Progress:  294 on 1000  Progress:  295 on 1000  Progress:  296 on 1000  Progress:  297 on 1000  Progress:  298 on 1000  Progress:  299 on 1000  Progress:  300 on 1000  Progress:  301 on 1000  Progress:  302 on 1000  Progress:  303 on 1000  Progress:  304 on 1000  Progress:  305 on 1000  Progress:  306 on 1000  Progress:  307 on 1000  Progress:  308 on 1000  Progress:  309 on 1000  Progress:  310 on 1000  Progress:  311 on 1000  Progress:  312 on 1000  Progress:  313 on 1000  Progress:  314 on 1000  Progress:  315 on 1000  Progress:  316 on 1000  Progress:  317 on 1000  Progress:  318 on 1000  Progress:  319 on 1000  Progress:  320 on 1000  Progress:  321 on 1000  Progress:  322 on 1000  Progress:  323 on 1000  Progress:  324 on 1000  Progress:  325 on 1000  Progress:  326 on 1000  Progress:  327 on 1000  Progress:  328 on 1000  Progress:  329 on 1000  Progress:  330 on 1000  Progress:  331 on 1000  Progress:  332 on 1000  Progress:  333 on 1000  Progress:  334 on 1000  Progress:  335 on 1000  Progress:  336 on 1000  Progress:  337 on 1000  Progress:  338 on 1000  Progress:  339 on 1000  Progress:  340 on 1000  Progress:  341 on 1000  Progress:  342 on 1000  Progress:  343 on 1000  Progress:  344 on 1000  Progress:  345 on 1000  Progress:  346 on 1000  Progress:  347 on 1000  Progress:  348 on 1000  Progress:  349 on 1000  Progress:  350 on 1000  Progress:  351 on 1000  Progress:  352 on 1000  Progress:  353 on 1000  Progress:  354 on 1000  Progress:  355 on 1000  Progress:  356 on 1000  Progress:  357 on 1000  Progress:  358 on 1000  Progress:  359 on 1000  Progress:  360 on 1000  Progress:  361 on 1000  Progress:  362 on 1000  Progress:  363 on 1000  Progress:  364 on 1000  Progress:  365 on 1000  Progress:  366 on 1000  Progress:  367 on 1000  Progress:  368 on 1000  Progress:  369 on 1000  Progress:  370 on 1000  Progress:  371 on 1000  Progress:  372 on 1000  Progress:  373 on 1000  Progress:  374 on 1000  Progress:  375 on 1000  Progress:  376 on 1000  Progress:  377 on 1000  Progress:  378 on 1000  Progress:  379 on 1000  Progress:  380 on 1000  Progress:  381 on 1000  Progress:  382 on 1000  Progress:  383 on 1000  Progress:  384 on 1000  Progress:  385 on 1000  Progress:  386 on 1000  Progress:  387 on 1000  Progress:  388 on 1000  Progress:  389 on 1000  Progress:  390 on 1000  Progress:  391 on 1000  Progress:  392 on 1000  Progress:  393 on 1000  Progress:  394 on 1000  Progress:  395 on 1000  Progress:  396 on 1000  Progress:  397 on 1000  Progress:  398 on 1000  Progress:  399 on 1000  Progress:  400 on 1000  Progress:  401 on 1000  Progress:  402 on 1000  Progress:  403 on 1000  Progress:  404 on 1000  Progress:  405 on 1000  Progress:  406 on 1000  Progress:  407 on 1000  Progress:  408 on 1000  Progress:  409 on 1000  Progress:  410 on 1000  Progress:  411 on 1000  Progress:  412 on 1000  Progress:  413 on 1000  Progress:  414 on 1000  Progress:  415 on 1000  Progress:  416 on 1000  Progress:  417 on 1000  Progress:  418 on 1000  Progress:  419 on 1000  Progress:  420 on 1000  Progress:  421 on 1000  Progress:  422 on 1000  Progress:  423 on 1000  Progress:  424 on 1000  Progress:  425 on 1000  Progress:  426 on 1000  Progress:  427 on 1000  Progress:  428 on 1000  Progress:  429 on 1000  Progress:  430 on 1000  Progress:  431 on 1000  Progress:  432 on 1000  Progress:  433 on 1000  Progress:  434 on 1000  Progress:  435 on 1000  Progress:  436 on 1000  Progress:  437 on 1000  Progress:  438 on 1000  Progress:  439 on 1000  Progress:  440 on 1000  Progress:  441 on 1000  Progress:  442 on 1000  Progress:  443 on 1000  Progress:  444 on 1000  Progress:  445 on 1000  Progress:  446 on 1000  Progress:  447 on 1000  Progress:  448 on 1000  Progress:  449 on 1000  Progress:  450 on 1000  Progress:  451 on 1000  Progress:  452 on 1000  Progress:  453 on 1000  Progress:  454 on 1000  Progress:  455 on 1000  Progress:  456 on 1000  Progress:  457 on 1000  Progress:  458 on 1000  Progress:  459 on 1000  Progress:  460 on 1000  Progress:  461 on 1000  Progress:  462 on 1000  Progress:  463 on 1000  Progress:  464 on 1000  Progress:  465 on 1000  Progress:  466 on 1000  Progress:  467 on 1000  Progress:  468 on 1000  Progress:  469 on 1000  Progress:  470 on 1000  Progress:  471 on 1000  Progress:  472 on 1000  Progress:  473 on 1000  Progress:  474 on 1000  Progress:  475 on 1000  Progress:  476 on 1000  Progress:  477 on 1000  Progress:  478 on 1000  Progress:  479 on 1000  Progress:  480 on 1000  Progress:  481 on 1000  Progress:  482 on 1000  Progress:  483 on 1000  Progress:  484 on 1000  Progress:  485 on 1000  Progress:  486 on 1000  Progress:  487 on 1000  Progress:  488 on 1000  Progress:  489 on 1000  Progress:  490 on 1000  Progress:  491 on 1000  Progress:  492 on 1000  Progress:  493 on 1000  Progress:  494 on 1000  Progress:  495 on 1000  Progress:  496 on 1000  Progress:  497 on 1000  Progress:  498 on 1000  Progress:  499 on 1000  Progress:  500 on 1000  Progress:  501 on 1000  Progress:  502 on 1000  Progress:  503 on 1000  Progress:  504 on 1000  Progress:  505 on 1000  Progress:  506 on 1000  Progress:  507 on 1000  Progress:  508 on 1000  Progress:  509 on 1000  Progress:  510 on 1000  Progress:  511 on 1000  Progress:  512 on 1000  Progress:  513 on 1000  Progress:  514 on 1000  Progress:  515 on 1000  Progress:  516 on 1000  Progress:  517 on 1000  Progress:  518 on 1000  Progress:  519 on 1000  Progress:  520 on 1000  Progress:  521 on 1000  Progress:  522 on 1000  Progress:  523 on 1000  Progress:  524 on 1000  Progress:  525 on 1000  Progress:  526 on 1000  Progress:  527 on 1000  Progress:  528 on 1000  Progress:  529 on 1000  Progress:  530 on 1000  Progress:  531 on 1000  Progress:  532 on 1000  Progress:  533 on 1000  Progress:  534 on 1000  Progress:  535 on 1000  Progress:  536 on 1000  Progress:  537 on 1000  Progress:  538 on 1000  Progress:  539 on 1000  Progress:  540 on 1000  Progress:  541 on 1000  Progress:  542 on 1000  Progress:  543 on 1000  Progress:  544 on 1000  Progress:  545 on 1000  Progress:  546 on 1000  Progress:  547 on 1000  Progress:  548 on 1000  Progress:  549 on 1000  Progress:  550 on 1000  Progress:  551 on 1000  Progress:  552 on 1000  Progress:  553 on 1000  Progress:  554 on 1000  Progress:  555 on 1000  Progress:  556 on 1000  Progress:  557 on 1000  Progress:  558 on 1000  Progress:  559 on 1000  Progress:  560 on 1000  Progress:  561 on 1000  Progress:  562 on 1000  Progress:  563 on 1000  Progress:  564 on 1000  Progress:  565 on 1000  Progress:  566 on 1000  Progress:  567 on 1000  Progress:  568 on 1000  Progress:  569 on 1000  Progress:  570 on 1000  Progress:  571 on 1000  Progress:  572 on 1000  Progress:  573 on 1000  Progress:  574 on 1000  Progress:  575 on 1000  Progress:  576 on 1000  Progress:  577 on 1000  Progress:  578 on 1000  Progress:  579 on 1000  Progress:  580 on 1000  Progress:  581 on 1000  Progress:  582 on 1000  Progress:  583 on 1000  Progress:  584 on 1000  Progress:  585 on 1000  Progress:  586 on 1000  Progress:  587 on 1000  Progress:  588 on 1000  Progress:  589 on 1000  Progress:  590 on 1000  Progress:  591 on 1000  Progress:  592 on 1000  Progress:  593 on 1000  Progress:  594 on 1000  Progress:  595 on 1000  Progress:  596 on 1000  Progress:  597 on 1000  Progress:  598 on 1000  Progress:  599 on 1000  Progress:  600 on 1000  Progress:  601 on 1000  Progress:  602 on 1000  Progress:  603 on 1000  Progress:  604 on 1000  Progress:  605 on 1000  Progress:  606 on 1000  Progress:  607 on 1000  Progress:  608 on 1000  Progress:  609 on 1000  Progress:  610 on 1000  Progress:  611 on 1000  Progress:  612 on 1000  Progress:  613 on 1000  Progress:  614 on 1000  Progress:  615 on 1000  Progress:  616 on 1000  Progress:  617 on 1000  Progress:  618 on 1000  Progress:  619 on 1000  Progress:  620 on 1000  Progress:  621 on 1000  Progress:  622 on 1000  Progress:  623 on 1000  Progress:  624 on 1000  Progress:  625 on 1000  Progress:  626 on 1000  Progress:  627 on 1000  Progress:  628 on 1000  Progress:  629 on 1000  Progress:  630 on 1000  Progress:  631 on 1000  Progress:  632 on 1000  Progress:  633 on 1000  Progress:  634 on 1000  Progress:  635 on 1000  Progress:  636 on 1000  Progress:  637 on 1000  Progress:  638 on 1000  Progress:  639 on 1000  Progress:  640 on 1000  Progress:  641 on 1000  Progress:  642 on 1000  Progress:  643 on 1000  Progress:  644 on 1000  Progress:  645 on 1000  Progress:  646 on 1000  Progress:  647 on 1000  Progress:  648 on 1000  Progress:  649 on 1000  Progress:  650 on 1000  Progress:  651 on 1000  Progress:  652 on 1000  Progress:  653 on 1000  Progress:  654 on 1000  Progress:  655 on 1000  Progress:  656 on 1000  Progress:  657 on 1000  Progress:  658 on 1000  Progress:  659 on 1000  Progress:  660 on 1000  Progress:  661 on 1000  Progress:  662 on 1000  Progress:  663 on 1000  Progress:  664 on 1000  Progress:  665 on 1000  Progress:  666 on 1000  Progress:  667 on 1000  Progress:  668 on 1000  Progress:  669 on 1000  Progress:  670 on 1000  Progress:  671 on 1000  Progress:  672 on 1000  Progress:  673 on 1000  Progress:  674 on 1000  Progress:  675 on 1000  Progress:  676 on 1000  Progress:  677 on 1000  Progress:  678 on 1000  Progress:  679 on 1000  Progress:  680 on 1000  Progress:  681 on 1000  Progress:  682 on 1000  Progress:  683 on 1000  Progress:  684 on 1000  Progress:  685 on 1000  Progress:  686 on 1000  Progress:  687 on 1000  Progress:  688 on 1000  Progress:  689 on 1000  Progress:  690 on 1000  Progress:  691 on 1000  Progress:  692 on 1000  Progress:  693 on 1000  Progress:  694 on 1000  Progress:  695 on 1000  Progress:  696 on 1000  Progress:  697 on 1000  Progress:  698 on 1000  Progress:  699 on 1000  Progress:  700 on 1000  Progress:  701 on 1000  Progress:  702 on 1000  Progress:  703 on 1000  Progress:  704 on 1000  Progress:  705 on 1000  Progress:  706 on 1000  Progress:  707 on 1000  Progress:  708 on 1000  Progress:  709 on 1000  Progress:  710 on 1000  Progress:  711 on 1000  Progress:  712 on 1000  Progress:  713 on 1000  Progress:  714 on 1000  Progress:  715 on 1000  Progress:  716 on 1000  Progress:  717 on 1000  Progress:  718 on 1000  Progress:  719 on 1000  Progress:  720 on 1000  Progress:  721 on 1000  Progress:  722 on 1000  Progress:  723 on 1000  Progress:  724 on 1000  Progress:  725 on 1000  Progress:  726 on 1000  Progress:  727 on 1000  Progress:  728 on 1000  Progress:  729 on 1000  Progress:  730 on 1000  Progress:  731 on 1000  Progress:  732 on 1000  Progress:  733 on 1000  Progress:  734 on 1000  Progress:  735 on 1000  Progress:  736 on 1000  Progress:  737 on 1000  Progress:  738 on 1000  Progress:  739 on 1000  Progress:  740 on 1000  Progress:  741 on 1000  Progress:  742 on 1000  Progress:  743 on 1000  Progress:  744 on 1000  Progress:  745 on 1000  Progress:  746 on 1000  Progress:  747 on 1000  Progress:  748 on 1000  Progress:  749 on 1000  Progress:  750 on 1000  Progress:  751 on 1000  Progress:  752 on 1000  Progress:  753 on 1000  Progress:  754 on 1000  Progress:  755 on 1000  Progress:  756 on 1000  Progress:  757 on 1000  Progress:  758 on 1000  Progress:  759 on 1000  Progress:  760 on 1000  Progress:  761 on 1000  Progress:  762 on 1000  Progress:  763 on 1000  Progress:  764 on 1000  Progress:  765 on 1000  Progress:  766 on 1000  Progress:  767 on 1000  Progress:  768 on 1000  Progress:  769 on 1000  Progress:  770 on 1000  Progress:  771 on 1000  Progress:  772 on 1000  Progress:  773 on 1000  Progress:  774 on 1000  Progress:  775 on 1000  Progress:  776 on 1000  Progress:  777 on 1000  Progress:  778 on 1000  Progress:  779 on 1000  Progress:  780 on 1000  Progress:  781 on 1000  Progress:  782 on 1000  Progress:  783 on 1000  Progress:  784 on 1000  Progress:  785 on 1000  Progress:  786 on 1000  Progress:  787 on 1000  Progress:  788 on 1000  Progress:  789 on 1000  Progress:  790 on 1000  Progress:  791 on 1000  Progress:  792 on 1000  Progress:  793 on 1000  Progress:  794 on 1000  Progress:  795 on 1000  Progress:  796 on 1000  Progress:  797 on 1000  Progress:  798 on 1000  Progress:  799 on 1000  Progress:  800 on 1000  Progress:  801 on 1000  Progress:  802 on 1000  Progress:  803 on 1000  Progress:  804 on 1000  Progress:  805 on 1000  Progress:  806 on 1000  Progress:  807 on 1000  Progress:  808 on 1000  Progress:  809 on 1000  Progress:  810 on 1000  Progress:  811 on 1000  Progress:  812 on 1000  Progress:  813 on 1000  Progress:  814 on 1000  Progress:  815 on 1000  Progress:  816 on 1000  Progress:  817 on 1000  Progress:  818 on 1000  Progress:  819 on 1000  Progress:  820 on 1000  Progress:  821 on 1000  Progress:  822 on 1000  Progress:  823 on 1000  Progress:  824 on 1000  Progress:  825 on 1000  Progress:  826 on 1000  Progress:  827 on 1000  Progress:  828 on 1000  Progress:  829 on 1000  Progress:  830 on 1000  Progress:  831 on 1000  Progress:  832 on 1000  Progress:  833 on 1000  Progress:  834 on 1000  Progress:  835 on 1000  Progress:  836 on 1000  Progress:  837 on 1000  Progress:  838 on 1000  Progress:  839 on 1000  Progress:  840 on 1000  Progress:  841 on 1000  Progress:  842 on 1000  Progress:  843 on 1000  Progress:  844 on 1000  Progress:  845 on 1000  Progress:  846 on 1000  Progress:  847 on 1000  Progress:  848 on 1000  Progress:  849 on 1000  Progress:  850 on 1000  Progress:  851 on 1000  Progress:  852 on 1000  Progress:  853 on 1000  Progress:  854 on 1000  Progress:  855 on 1000  Progress:  856 on 1000  Progress:  857 on 1000  Progress:  858 on 1000  Progress:  859 on 1000  Progress:  860 on 1000  Progress:  861 on 1000  Progress:  862 on 1000  Progress:  863 on 1000  Progress:  864 on 1000  Progress:  865 on 1000  Progress:  866 on 1000  Progress:  867 on 1000  Progress:  868 on 1000  Progress:  869 on 1000  Progress:  870 on 1000  Progress:  871 on 1000  Progress:  872 on 1000  Progress:  873 on 1000  Progress:  874 on 1000  Progress:  875 on 1000  Progress:  876 on 1000  Progress:  877 on 1000  Progress:  878 on 1000  Progress:  879 on 1000  Progress:  880 on 1000  Progress:  881 on 1000  Progress:  882 on 1000  Progress:  883 on 1000  Progress:  884 on 1000  Progress:  885 on 1000  Progress:  886 on 1000  Progress:  887 on 1000  Progress:  888 on 1000  Progress:  889 on 1000  Progress:  890 on 1000  Progress:  891 on 1000  Progress:  892 on 1000  Progress:  893 on 1000  Progress:  894 on 1000  Progress:  895 on 1000  Progress:  896 on 1000  Progress:  897 on 1000  Progress:  898 on 1000  Progress:  899 on 1000  Progress:  900 on 1000  Progress:  901 on 1000  Progress:  902 on 1000  Progress:  903 on 1000  Progress:  904 on 1000  Progress:  905 on 1000  Progress:  906 on 1000  Progress:  907 on 1000  Progress:  908 on 1000  Progress:  909 on 1000  Progress:  910 on 1000  Progress:  911 on 1000  Progress:  912 on 1000  Progress:  913 on 1000  Progress:  914 on 1000  Progress:  915 on 1000  Progress:  916 on 1000  Progress:  917 on 1000  Progress:  918 on 1000  Progress:  919 on 1000  Progress:  920 on 1000  Progress:  921 on 1000  Progress:  922 on 1000  Progress:  923 on 1000  Progress:  924 on 1000  Progress:  925 on 1000  Progress:  926 on 1000  Progress:  927 on 1000  Progress:  928 on 1000  Progress:  929 on 1000  Progress:  930 on 1000  Progress:  931 on 1000  Progress:  932 on 1000  Progress:  933 on 1000  Progress:  934 on 1000  Progress:  935 on 1000  Progress:  936 on 1000  Progress:  937 on 1000  Progress:  938 on 1000  Progress:  939 on 1000  Progress:  940 on 1000  Progress:  941 on 1000  Progress:  942 on 1000  Progress:  943 on 1000  Progress:  944 on 1000  Progress:  945 on 1000  Progress:  946 on 1000  Progress:  947 on 1000  Progress:  948 on 1000  Progress:  949 on 1000  Progress:  950 on 1000  Progress:  951 on 1000  Progress:  952 on 1000  Progress:  953 on 1000  Progress:  954 on 1000  Progress:  955 on 1000  Progress:  956 on 1000  Progress:  957 on 1000  Progress:  958 on 1000  Progress:  959 on 1000  Progress:  960 on 1000  Progress:  961 on 1000  Progress:  962 on 1000  Progress:  963 on 1000  Progress:  964 on 1000  Progress:  965 on 1000  Progress:  966 on 1000  Progress:  967 on 1000  Progress:  968 on 1000  Progress:  969 on 1000  Progress:  970 on 1000  Progress:  971 on 1000  Progress:  972 on 1000  Progress:  973 on 1000  Progress:  974 on 1000  Progress:  975 on 1000  Progress:  976 on 1000  Progress:  977 on 1000  Progress:  978 on 1000  Progress:  979 on 1000  Progress:  980 on 1000  Progress:  981 on 1000  Progress:  982 on 1000  Progress:  983 on 1000  Progress:  984 on 1000  Progress:  985 on 1000  Progress:  986 on 1000  Progress:  987 on 1000  Progress:  988 on 1000  Progress:  989 on 1000  Progress:  990 on 1000  Progress:  991 on 1000  Progress:  992 on 1000  Progress:  993 on 1000  Progress:  994 on 1000  Progress:  995 on 1000  Progress:  996 on 1000  Progress:  997 on 1000  Progress:  998 on 1000  Progress:  999 on 1000  Progress: 1000 on 1000  [1] "SpaceBF: NB model fitting completed!"
```

## Perform significance tests

Perform global and local-level hypothesis tests using *bayestestR*.

``` r
G_results <- global_res(MM$Beta[, -c(1:N)], local.p.ths = 0.9)
L_results <- local_res(MM$Beta[, -c(1:N)], local.p.ths = 0.9)
```

## Heatmap of -log10 of p-values

Display the -log10 of the p-values using heatmap.

``` r
plot_estimates(MM$Beta[, -c(1:N)], y1, y2, coords[, 1:2], which.model = "NB")
```

<img src="README_files/figure-gfm/P-value visualization-1.png" width="50%" />

## Visualizing summary functions

Next, we can check the summary functions corresponding to those pairs of
cell types whose p-values turned out to be significant. Here, we
visualize the g-functions of pairs: (alpha, delta) and (beta, Th). For
every pair, the first panel shows subject-level mean functions (averaged
across the images of a subject), while the second panel shows
image-level summary functions. We also display the point-wise F-values
which might help to understand which particular values of the radius r
are most influential, i.e., where the maximum difference between the
group-level summary functions are observed.

### Pair: (alpha, delta)

We notice that the spatial co-occurrence of alpha and delta cells is
positive in both the groups but higher in the “Onset” group.

``` r
# Pointwise_Fvals = Final_result[[1]][[2]]
# Functional_results = Final_result[[2]]
# 
# # Pair: (alpha, delta)
# Plot.functions(Functional_results, pair = c("alpha", "delta"), Fvals = Pointwise_Fvals)
```

## Visualizing cellular organization

We can visualize cellular organization in different images of every
subject. Here, 4 images each are shown for two subjects, “6126” from
group “Non-diabetic” and “6414” from group “Onset”.

``` r
# table(IMC_T1DM$cellType)
# palette = c("darkorchid1","red", "cyan", "grey", "blue", "green") #assign colors to cell types 
# 
# Plot.cellTypes(data = IMC_T1DM, ID = "6126", palette = palette)
# Plot.cellTypes(data = IMC_T1DM, ID = "6414", palette = palette)
```

## References

1\) Seal, S., & Neelon, B. (2025). SpaceBF: Spatial coexpression
analysis using Bayesian Fused approaches in spatial omics datasets.
bioRxiv, 2025-03.

2\) K. Thrane, H. Eriksson, J. Maaskola, J. Hansson, and J. Lundeberg
(2018). Spatially resolved transcriptomics enables dissection of genetic
heterogeneity in stage III cutaneous malignant melanoma. Cancer
research, 78(20):5970–5979.
